.PHONY: help install clean dev build preview test lint format audit deps check-node check-env status stop open

# Colors
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
CYAN := \033[0;36m
PURPLE := \033[0;35m
BLUE := \033[0;34m
WHITE := \033[1;37m
NC := \033[0m

# Emojis for better visual feedback
CHECK := âœ“
CROSS := âœ—
ARROW := â†’
STAR := â˜…

# Variables
NODE_MIN_VERSION := 18.0.0
NPM_MIN_VERSION := 9.0.0
FRONTEND_PORT := 5173
FRONTEND_URL := http://localhost:$(FRONTEND_PORT)
BACKEND_PORT := 8000
BACKEND_URL := http://localhost:$(BACKEND_PORT)
API_URL := $(BACKEND_URL)/api
NODE_MODULES := node_modules
BUILD_DIR := dist
PREVIEW_PORT := 4173

# OS Detection for cross-platform commands
UNAME := $(shell uname)
ifeq ($(UNAME), Darwin)
    OPEN_CMD := open
else ifeq ($(UNAME), Linux)
    OPEN_CMD := xdg-open
else
    OPEN_CMD := start
endif

# Default target
.DEFAULT_GOAL := help

help:
	@echo ""
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘       âš›ï¸  E-Bike Point ERP - Frontend Commands         â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(BLUE)Usage: make <command>$(NC)"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸš€ Quick Start Commands$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)setup$(NC)                $(ARROW) ğŸ¯ Complete setup (install + check + open)"
	@echo "  $(CYAN)dev$(NC)                  $(ARROW) ğŸ”§ Start dev server"
	@echo "  $(CYAN)dev-open$(NC)             $(ARROW) ğŸŒ Start dev server + open browser"
	@echo "  $(CYAN)open$(NC)                 $(ARROW) ğŸŒ Open app in browser"
	@echo "  $(CYAN)stop$(NC)                 $(ARROW) ğŸ›‘ Stop all servers"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ’» Development$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)dev$(NC)                  $(ARROW) ğŸŒ Start Vite dev server"
	@echo "  $(CYAN)dev-open$(NC)             $(ARROW) ğŸŒ Dev server + auto-open browser"
	@echo "  $(CYAN)dev-host$(NC)             $(ARROW) ğŸ“¡ Dev server (network accessible)"
	@echo "  $(CYAN)dev-host-open$(NC)        $(ARROW) ğŸ“¡ Network dev + open browser"
	@echo "  $(CYAN)dev-debug$(NC)            $(ARROW) ğŸ› Dev server with debug mode"
	@echo "  $(CYAN)restart$(NC)              $(ARROW) ğŸ”„ Restart dev server"
	@echo "  $(CYAN)stop$(NC)                 $(ARROW) ğŸ›‘ Stop dev server"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸŒ Browser & Navigation$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)open$(NC)                 $(ARROW) ğŸŒ Open homepage"
	@echo "  $(CYAN)open-login$(NC)           $(ARROW) ğŸ” Open login page"
	@echo "  $(CYAN)open-register$(NC)        $(ARROW) ğŸ“ Open registration"
	@echo "  $(CYAN)open-admin$(NC)           $(ARROW) ğŸ‘¨â€ğŸ’¼ Open admin dashboard"
	@echo "  $(CYAN)open-api$(NC)             $(ARROW) ğŸ“¡ Open backend API"
	@echo "  $(CYAN)open-build$(NC)           $(ARROW) ğŸ“¦ Open production preview"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ—ï¸  Build & Deploy$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)build$(NC)                $(ARROW) ğŸ—ï¸  Build for production"
	@echo "  $(CYAN)build-check$(NC)          $(ARROW) âœ… Build + verify output"
	@echo "  $(CYAN)preview$(NC)              $(ARROW) ğŸ‘€ Preview production build"
	@echo "  $(CYAN)preview-open$(NC)         $(ARROW) ğŸ‘€ Preview + open browser"
	@echo "  $(CYAN)build-analyze$(NC)        $(ARROW) ğŸ“Š Analyze bundle size"
	@echo "  $(CYAN)serve$(NC)                $(ARROW) ğŸš€ Serve production build"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ§ª Testing & Quality$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)test$(NC)                 $(ARROW) ğŸ§ª Run tests"
	@echo "  $(CYAN)test-watch$(NC)           $(ARROW) ğŸ‘ï¸  Run tests in watch mode"
	@echo "  $(CYAN)test-coverage$(NC)        $(ARROW) ğŸ“Š Generate coverage report"
	@echo "  $(CYAN)lint$(NC)                 $(ARROW) ğŸ” Run ESLint"
	@echo "  $(CYAN)lint-fix$(NC)             $(ARROW) ğŸ”§ Fix ESLint errors"
	@echo "  $(CYAN)format$(NC)               $(ARROW) âœ¨ Format code with Prettier"
	@echo "  $(CYAN)format-check$(NC)         $(ARROW) ğŸ” Check code formatting"
	@echo "  $(CYAN)quality$(NC)              $(ARROW) ğŸ† Run all quality checks"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ¥ Health & Monitoring$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)health$(NC)               $(ARROW) ğŸ¥ Complete health check"
	@echo "  $(CYAN)check-all$(NC)            $(ARROW) ğŸ” Run all checks"
	@echo "  $(CYAN)check-ports$(NC)          $(ARROW) ğŸ”Œ Check if ports are free"
	@echo "  $(CYAN)monitor$(NC)              $(ARROW) ğŸ“Š Monitor services (live)"
	@echo "  $(CYAN)logs$(NC)                 $(ARROW) ğŸ“‹ Show recent logs"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ“¦ Dependencies$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)install$(NC)              $(ARROW) ğŸ“¦ Install dependencies"
	@echo "  $(CYAN)install-clean$(NC)        $(ARROW) ğŸ§¹ Clean install"
	@echo "  $(CYAN)deps$(NC)                 $(ARROW) ğŸ“‹ List dependencies"
	@echo "  $(CYAN)deps-check$(NC)           $(ARROW) ğŸ” Check for issues"
	@echo "  $(CYAN)deps-update$(NC)          $(ARROW) â¬†ï¸  Update all packages"
	@echo "  $(CYAN)audit$(NC)                $(ARROW) ğŸ”’ Security audit"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ”§ Utilities$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)clean$(NC)                $(ARROW) ğŸ§¹ Clean build artifacts"
	@echo "  $(CYAN)clean-all$(NC)            $(ARROW) ğŸ§¹ Deep clean (includes node_modules)"
	@echo "  $(CYAN)reset$(NC)                $(ARROW) ğŸ”„ Complete reset"
	@echo "  $(CYAN)backup$(NC)               $(ARROW) ğŸ’¾ Backup current state"
	@echo ""
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(YELLOW)$(STAR) Quick Start:$(NC) make setup"
	@echo "$(YELLOW)$(STAR) Development:$(NC) make dev-open"
	@echo "$(YELLOW)$(STAR) Production:$(NC)  make build && make preview-open"
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""

# ============================================
# ğŸš€ Quick Start Commands
# ============================================

setup: install check-all
	@echo ""
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(GREEN)â•‘     $(CHECK) Setup Complete!                     â•‘$(NC)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(CYAN)Next steps:$(NC)"
	@echo "  1. $(YELLOW)make dev-open$(NC)     $(ARROW) Start development"
	@echo "  2. $(YELLOW)make open-login$(NC)   $(ARROW) Test login page"
	@echo ""

# ============================================
# ğŸ’» Development Commands
# ============================================

dev: check-env check-ports
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘      ğŸš€ Starting Development Server       â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(CYAN)  URL:$(NC) $(WHITE)$(FRONTEND_URL)$(NC)"
	@echo "$(CYAN)  API:$(NC) $(WHITE)$(API_URL)$(NC)"
	@echo ""
	@echo "$(YELLOW)  Press Ctrl+C to stop$(NC)"
	@echo ""
	@npm run dev

dev-open: check-env check-ports
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘   ğŸš€ Starting Dev Server (Auto-Open)      â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@$(MAKE) open-delay &
	@npm run dev

dev-host: check-env
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘  ğŸ“¡ Starting Dev Server (Network Mode)    â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)  Network access enabled$(NC)"
	@echo ""
	@npm run dev -- --host

dev-host-open: check-env
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘  ğŸ“¡ Network Dev Server (Auto-Open)        â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@$(MAKE) open-delay &
	@npm run dev -- --host --open

dev-debug:
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘      ğŸ› Debug Mode Development            â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@DEBUG=* npm run dev

# ============================================
# ğŸŒ Browser Commands
# ============================================

open:
	@echo "$(CYAN)ğŸŒ Opening E-Bike Point...$(NC)"
	@$(OPEN_CMD) $(FRONTEND_URL) 2>/dev/null || { \
		echo "$(YELLOW)  Trying alternative...$(NC)"; \
		python3 -m webbrowser $(FRONTEND_URL) 2>/dev/null || \
		echo "$(RED)  $(CROSS) Could not open browser$(NC)"; \
		echo "$(CYAN)  Please open manually: $(WHITE)$(FRONTEND_URL)$(NC)"; \
	}

open-delay:
	@sleep 3 && $(MAKE) open

open-login:
	@echo "$(CYAN)ğŸ” Opening login page...$(NC)"
	@$(OPEN_CMD) $(FRONTEND_URL)/login

open-register:
	@echo "$(CYAN)ğŸ“ Opening registration page...$(NC)"
	@$(OPEN_CMD) $(FRONTEND_URL)/register

open-admin:
	@echo "$(CYAN)ğŸ‘¨â€ğŸ’¼ Opening admin dashboard...$(NC)"
	@$(OPEN_CMD) $(FRONTEND_URL)/admin/dashboard

open-api:
	@echo "$(CYAN)ğŸ“¡ Opening API documentation...$(NC)"
	@$(OPEN_CMD) $(API_URL)

open-build:
	@if lsof -Pi :$(PREVIEW_PORT) -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "$(CYAN)ğŸ“¦ Opening production preview...$(NC)"; \
		$(OPEN_CMD) http://localhost:$(PREVIEW_PORT); \
	else \
		echo "$(YELLOW)$(CROSS) Preview server not running$(NC)"; \
		echo "$(CYAN)  Run: make preview-open$(NC)"; \
	fi

# ============================================
# ğŸ—ï¸ Build Commands
# ============================================

build: check-env
	@echo "$(YELLOW)ğŸ—ï¸  Building for production...$(NC)"
	@npm run build
	@echo ""
	@echo "$(GREEN)$(CHECK) Build complete!$(NC)"
	@echo "$(CYAN)  Output: $(BUILD_DIR)/$(NC)"
	@if [ -d "$(BUILD_DIR)" ]; then \
		SIZE=$$(du -sh $(BUILD_DIR) | cut -f1); \
		FILES=$$(find $(BUILD_DIR) -type f | wc -l | xargs); \
		echo "$(CYAN)  Size:   $$SIZE$(NC)"; \
		echo "$(CYAN)  Files:  $$FILES$(NC)"; \
	fi
	@echo ""
	@echo "$(YELLOW)Next: make preview-open$(NC)"

build-check: build
	@echo ""
	@echo "$(YELLOW)ğŸ” Verifying build...$(NC)"
	@if [ -d "$(BUILD_DIR)" ]; then \
		echo "$(GREEN)  $(CHECK) Build directory exists$(NC)"; \
		if [ -f "$(BUILD_DIR)/index.html" ]; then \
			echo "$(GREEN)  $(CHECK) index.html found$(NC)"; \
		else \
			echo "$(RED)  $(CROSS) index.html missing$(NC)"; \
			exit 1; \
		fi; \
		if [ -d "$(BUILD_DIR)/assets" ]; then \
			echo "$(GREEN)  $(CHECK) assets directory found$(NC)"; \
		else \
			echo "$(RED)  $(CROSS) assets directory missing$(NC)"; \
		fi; \
	else \
		echo "$(RED)  $(CROSS) Build directory missing$(NC)"; \
		exit 1; \
	fi
	@echo ""
	@echo "$(GREEN)$(CHECK) Build verification passed!$(NC)"

preview: build
	@echo "$(CYAN)ğŸ‘€ Starting production preview...$(NC)"
	@echo "$(YELLOW)  URL: http://localhost:$(PREVIEW_PORT)$(NC)"
	@echo ""
	@npm run preview

preview-open: build
	@echo "$(CYAN)ğŸ‘€ Starting production preview...$(NC)"
	@$(MAKE) open-preview-delay &
	@npm run preview

open-preview-delay:
	@sleep 2 && $(OPEN_CMD) http://localhost:$(PREVIEW_PORT)

serve: build
	@echo "$(CYAN)ğŸš€ Serving production build...$(NC)"
	@npx serve $(BUILD_DIR) -p $(PREVIEW_PORT)

# ============================================
# ğŸ§ª Testing & Quality Commands
# ============================================

test:
	@echo "$(YELLOW)ğŸ§ª Running tests...$(NC)"
	@npm run test 2>/dev/null || { \
		echo "$(YELLOW)  $(CROSS) No tests configured$(NC)"; \
		echo "$(CYAN)  Add tests with: npm install -D vitest @testing-library/react$(NC)"; \
	}

test-watch:
	@echo "$(YELLOW)ğŸ‘ï¸  Running tests in watch mode...$(NC)"
	@npm run test -- --watch 2>/dev/null || echo "$(YELLOW)Configure test:watch script$(NC)"

test-coverage:
	@echo "$(YELLOW)ğŸ“Š Generating coverage report...$(NC)"
	@npm run test -- --coverage 2>/dev/null || echo "$(YELLOW)Configure coverage$(NC)"

lint:
	@echo "$(YELLOW)ğŸ” Running ESLint...$(NC)"
	@npm run lint 2>/dev/null || { \
		npx eslint src --ext .js,.jsx,.ts,.tsx 2>/dev/null || \
		echo "$(YELLOW)  ESLint not configured$(NC)"; \
	}

lint-fix:
	@echo "$(YELLOW)ğŸ”§ Fixing ESLint errors...$(NC)"
	@npm run lint -- --fix 2>/dev/null || { \
		npx eslint src --ext .js,.jsx,.ts,.tsx --fix 2>/dev/null || \
		echo "$(YELLOW)  ESLint not configured$(NC)"; \
	}

format:
	@echo "$(YELLOW)âœ¨ Formatting code...$(NC)"
	@npx prettier --write "src/**/*.{js,jsx,ts,tsx,css,md}" 2>/dev/null || { \
		echo "$(YELLOW)  Installing Prettier...$(NC)"; \
		npm install -D prettier; \
		npx prettier --write "src/**/*.{js,jsx,ts,tsx,css,md}"; \
	}
	@echo "$(GREEN)  $(CHECK) Code formatted$(NC)"

format-check:
	@echo "$(YELLOW)ğŸ” Checking code format...$(NC)"
	@npx prettier --check "src/**/*.{js,jsx,ts,tsx,css,md}" 2>/dev/null || { \
		echo "$(YELLOW)  Code needs formatting$(NC)"; \
		echo "$(CYAN)  Run: make format$(NC)"; \
		exit 1; \
	}

quality: lint format-check test
	@echo ""
	@echo "$(GREEN)$(CHECK) All quality checks passed!$(NC)"

# ============================================
# ğŸ¥ Health & Monitoring Commands
# ============================================

health: check-all
	@echo ""
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(GREEN)â•‘       ğŸ¥ System Health Report             â•‘$(NC)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(CYAN)Frontend Status:$(NC)"
	@if lsof -Pi :$(FRONTEND_PORT) -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "  Dev Server:    $(GREEN)$(CHECK) Running on port $(FRONTEND_PORT)$(NC)"; \
		echo "  Access URL:    $(CYAN)$(FRONTEND_URL)$(NC)"; \
	else \
		echo "  Dev Server:    $(YELLOW)â—‹ Not running$(NC)"; \
		echo "                 $(CYAN)Run: make dev-open$(NC)"; \
	fi
	@echo ""
	@echo "$(CYAN)Backend Status:$(NC)"
	@if curl -s -o /dev/null -w "%{http_code}" $(API_URL) | grep -q "200\|301\|302"; then \
		echo "  API Server:    $(GREEN)$(CHECK) Accessible$(NC)"; \
		echo "  API URL:       $(CYAN)$(API_URL)$(NC)"; \
	else \
		echo "  API Server:    $(RED)$(CROSS) Not accessible$(NC)"; \
		echo "                 $(CYAN)Start with: cd ../server && make dev$(NC)"; \
	fi
	@echo ""
	@if [ -d "$(BUILD_DIR)" ]; then \
		SIZE=$$(du -sh $(BUILD_DIR) 2>/dev/null | cut -f1); \
		echo "$(CYAN)Production Build:$(NC)"; \
		echo "  Status:        $(GREEN)$(CHECK) Built$(NC)"; \
		echo "  Size:          $(CYAN)$$SIZE$(NC)"; \
		MODIFIED=$$(date -r $(BUILD_DIR) "+%Y-%m-%d %H:%M" 2>/dev/null || echo "Unknown"); \
		echo "  Last Build:    $(CYAN)$$MODIFIED$(NC)"; \
	else \
		echo "$(CYAN)Production Build:$(NC)"; \
		echo "  Status:        $(YELLOW)â—‹ Not built$(NC)"; \
		echo "                 $(CYAN)Run: make build$(NC)"; \
	fi
	@echo ""

check-all: check-node check-env check-backend check-ports
	@echo ""
	@echo "$(GREEN)$(CHECK) All checks passed!$(NC)"

check-node:
	@echo "$(YELLOW)ğŸ” Checking Node.js environment...$(NC)"
	@command -v node >/dev/null 2>&1 || { \
		echo "$(RED)  $(CROSS) Node.js not found!$(NC)"; \
		echo "$(CYAN)  Install from: https://nodejs.org$(NC)"; \
		exit 1; \
	}
	@NODE_VERSION=$$(node -v | sed 's/v//'); \
	NODE_MAJOR=$$(echo $$NODE_VERSION | cut -d. -f1); \
	if [ $$NODE_MAJOR -lt 18 ]; then \
		echo "$(RED)  $(CROSS) Node.js 18+ required!$(NC)"; \
		echo "$(YELLOW)  Current: v$$NODE_VERSION$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)  $(CHECK) Node.js: $$(node -v)$(NC)"
	@echo "$(GREEN)  $(CHECK) npm: $$(npm -v)$(NC)"

check-env:
	@echo "$(YELLOW)ğŸ” Checking environment...$(NC)"
	@if [ ! -f .env ]; then \
		echo "$(YELLOW)  âš ï¸  .env file not found$(NC)"; \
		if [ -f .env.example ]; then \
			cp .env.example .env; \
			echo "$(GREEN)  $(CHECK) Created .env from template$(NC)"; \
			echo "$(YELLOW)  âš ï¸  Update .env with your values!$(NC)"; \
		else \
			echo "$(CYAN)  Creating default .env...$(NC)"; \
			echo "VITE_API_BASE_URL=http://localhost:8000/api" > .env; \
			echo "VITE_APP_NAME=E-Bike Point" >> .env; \
			echo "VITE_AUTO_LOGOUT_HOURS=9" >> .env; \
			echo "VITE_FREE_SERVICES_COUNT=4" >> .env; \
			echo "VITE_WARRANTY_MONTHS=24" >> .env; \
			echo "$(GREEN)  $(CHECK) Created default .env$(NC)"; \
		fi \
	else \
		echo "$(GREEN)  $(CHECK) .env exists$(NC)"; \
	fi

check-backend:
	@echo "$(YELLOW)ğŸ” Checking backend connection...$(NC)"
	@BACKEND_URL=$$(grep VITE_API_BASE_URL .env 2>/dev/null | cut -d '=' -f2 | tr -d ' ' || echo "http://localhost:8000/api"); \
	if curl -s -o /dev/null -w "%{http_code}" $$BACKEND_URL | grep -q "200\|301\|302"; then \
		echo "$(GREEN)  $(CHECK) Backend accessible at $$BACKEND_URL$(NC)"; \
	else \
		echo "$(YELLOW)  âš ï¸  Backend not responding$(NC)"; \
		echo "$(CYAN)  Start backend: cd ../server && make dev$(NC)"; \
	fi

check-ports:
	@echo "$(YELLOW)ğŸ”Œ Checking ports...$(NC)"
	@if lsof -Pi :$(FRONTEND_PORT) -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "$(YELLOW)  âš ï¸  Port $(FRONTEND_PORT) already in use$(NC)"; \
		PID=$$(lsof -Pi :$(FRONTEND_PORT) -sTCP:LISTEN -t); \
		echo "$(CYAN)  Process PID: $$PID$(NC)"; \
		echo "$(CYAN)  Run 'make stop' to free the port$(NC)"; \
	else \
		echo "$(GREEN)  $(CHECK) Port $(FRONTEND_PORT) available$(NC)"; \
	fi

monitor:
	@echo "$(CYAN)ğŸ“Š Monitoring services (Press Ctrl+C to exit)...$(NC)"
	@echo ""
	@while true; do \
		clear; \
		echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"; \
		echo "$(CYAN)â•‘       ğŸ“Š E-Bike Point Monitor             â•‘$(NC)"; \
		echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"; \
		echo ""; \
		echo "$(WHITE)Time: $$(date '+%H:%M:%S')$(NC)"; \
		echo ""; \
		echo -n "Frontend ($(FRONTEND_PORT)): "; \
		lsof -Pi :$(FRONTEND_PORT) -sTCP:LISTEN -t >/dev/null 2>&1 && \
			echo "$(GREEN)â— Running$(NC)" || echo "$(RED)â—‹ Stopped$(NC)"; \
		echo -n "Backend  ($(BACKEND_PORT)): "; \
		lsof -Pi :$(BACKEND_PORT) -sTCP:LISTEN -t >/dev/null 2>&1 && \
			echo "$(GREEN)â— Running$(NC)" || echo "$(RED)â—‹ Stopped$(NC)"; \
		echo -n "Preview  ($(PREVIEW_PORT)): "; \
		lsof -Pi :$(PREVIEW_PORT) -sTCP:LISTEN -t >/dev/null 2>&1 && \
			echo "$(GREEN)â— Running$(NC)" || echo "$(YELLOW)â—‹ Stopped$(NC)"; \
		echo ""; \
		echo "$(CYAN)Press Ctrl+C to exit$(NC)"; \
		sleep 2; \
	done

logs:
	@echo "$(CYAN)ğŸ“‹ Recent Vite logs:$(NC)"
	@echo ""
	@tail -n 20 ~/.npm/_logs/*.log 2>/dev/null || echo "$(YELLOW)No recent logs found$(NC)"

# ============================================
# ğŸ“¦ Dependencies Commands
# ============================================

install: check-node
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘     ğŸ“¦ Installing Dependencies            â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@if [ -d "$(NODE_MODULES)" ]; then \
		echo "$(YELLOW)  âš ï¸  node_modules exists$(NC)"; \
		echo "$(CYAN)  Use 'make install-clean' for fresh install$(NC)"; \
	fi
	@echo "$(YELLOW)Installing packages...$(NC)"
	@npm install --silent
	@echo "$(GREEN)$(CHECK) Dependencies installed$(NC)"
	@echo ""
	@$(MAKE) check-env

install-clean: clean-all install
	@echo "$(GREEN)$(CHECK) Clean installation complete!$(NC)"

deps:
	@echo "$(CYAN)ğŸ“¦ Installed packages:$(NC)"
	@echo ""
	@npm list --depth=0 | grep -v "deduped" || echo "$(YELLOW)No dependencies$(NC)"

deps-check:
	@echo "$(YELLOW)ğŸ” Checking dependencies...$(NC)"
	@echo ""
	@echo "$(CYAN)Outdated packages:$(NC)"
	@npm outdated || echo "$(GREEN)  $(CHECK) All packages up to date$(NC)"
	@echo ""
	@echo "$(CYAN)Security audit:$(NC)"
	@npm audit --audit-level=moderate || true

deps-update:
	@echo "$(YELLOW)â¬†ï¸  Updating dependencies...$(NC)"
	@npm update
	@echo "$(GREEN)$(CHECK) Dependencies updated$(NC)"
	@echo "$(CYAN)Run 'make audit' to check for vulnerabilities$(NC)"

audit:
	@echo "$(YELLOW)ğŸ”’ Running security audit...$(NC)"
	@npm audit
	@echo ""
	@echo "$(CYAN)To fix issues: make audit-fix$(NC)"

audit-fix:
	@echo "$(YELLOW)ğŸ”§ Fixing vulnerabilities...$(NC)"
	@npm audit fix
	@echo "$(GREEN)$(CHECK) Security fixes applied$(NC)"

# ============================================
# ğŸ§¹ Cleanup Commands
# ============================================

clean:
	@echo "$(RED)ğŸ§¹ Cleaning build artifacts...$(NC)"
	@rm -rf $(BUILD_DIR) .vite node_modules/.vite .eslintcache
	@echo "$(GREEN)$(CHECK) Build artifacts cleaned$(NC)"

clean-all: clean
	@echo "$(RED)ğŸ§¹ Deep cleaning...$(NC)"
	@rm -rf $(NODE_MODULES) package-lock.json
	@echo "$(GREEN)$(CHECK) Deep clean complete$(NC)"

reset: clean-all
	@echo "$(RED)ğŸ”„ Resetting project...$(NC)"
	@git checkout package.json 2>/dev/null || true
	@git checkout package-lock.json 2>/dev/null || true
	@echo "$(GREEN)$(CHECK) Project reset$(NC)"
	@echo "$(CYAN)Run 'make setup' to reinstall$(NC)"

backup:
	@echo "$(YELLOW)ğŸ’¾ Creating backup...$(NC)"
	@mkdir -p backups
	@tar -czf backups/frontend-backup-$$(date +%Y%m%d-%H%M%S).tar.gz \
		--exclude=node_modules \
		--exclude=dist \
		--exclude=.vite \
		--exclude=backups \
		.
	@echo "$(GREEN)$(CHECK) Backup created in backups/$(NC)"

# ============================================
# ğŸ› ï¸ Utility Commands
# ============================================

stop:
	@echo "$(RED)ğŸ›‘ Stopping all servers...$(NC)"
	@lsof -ti:$(FRONTEND_PORT) | xargs kill -9 2>/dev/null || true
	@lsof -ti:$(PREVIEW_PORT) | xargs kill -9 2>/dev/null || true
	@echo "$(GREEN)$(CHECK) All servers stopped$(NC)"

restart: stop dev-open

status:
	@echo ""
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘        ğŸ“Š Frontend Status                 â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(CYAN)Environment:$(NC)"
	@echo "  Node.js:      $$(node -v 2>/dev/null || echo '$(RED)Not installed$(NC)')"
	@echo "  npm:          $$(npm -v 2>/dev/null || echo '$(RED)Not installed$(NC)')"
	@echo "  Dependencies: $$([ -d $(NODE_MODULES) ] && echo '$(GREEN)$(CHECK) Installed$(NC)' || echo '$(RED)$(CROSS) Not installed$(NC)')"
	@if [ -d $(NODE_MODULES) ]; then \
		PKG_COUNT=$$(ls -1 $(NODE_MODULES) | wc -l | xargs); \
		echo "  Packages:     $(CYAN)$$PKG_COUNT installed$(NC)"; \
	fi
	@echo ""
	@echo "$(CYAN)Configuration:$(NC)"
	@echo "  .env file:    $$([ -f .env ] && echo '$(GREEN)$(CHECK) Present$(NC)' || echo '$(RED)$(CROSS) Missing$(NC)')"
	@if [ -f .env ] && grep -q "VITE_API_BASE_URL" .env; then \
		API=$$(grep VITE_API_BASE_URL .env | cut -d '=' -f2); \
		echo "  API URL:      $(CYAN)$$API$(NC)"; \
	fi
	@echo ""
	@echo "$(CYAN)Services:$(NC)"
	@echo -n "  Dev Server:   "
	@if lsof -Pi :$(FRONTEND_PORT) -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "$(GREEN)$(CHECK) Running on port $(FRONTEND_PORT)$(NC)"; \
	else \
		echo "$(YELLOW)â—‹ Not running$(NC)"; \
	fi
	@echo -n "  Preview:      "
	@if lsof -Pi :$(PREVIEW_PORT) -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "$(GREEN)$(CHECK) Running on port $(PREVIEW_PORT)$(NC)"; \
	else \
		echo "$(YELLOW)â—‹ Not running$(NC)"; \
	fi
	@echo ""
	@echo "$(CYAN)Build:$(NC)"
	@if [ -d $(BUILD_DIR) ]; then \
		echo "  Status:       $(GREEN)$(CHECK) Built$(NC)"; \
		SIZE=$$(du -sh $(BUILD_DIR) | cut -f1); \
		echo "  Size:         $(CYAN)$$SIZE$(NC)"; \
	else \
		echo "  Status:       $(YELLOW)â—‹ Not built$(NC)"; \
	fi
	@echo ""

quick-status:
	@echo -n "Frontend: "; \
	lsof -Pi :$(FRONTEND_PORT) -sTCP:LISTEN -t >/dev/null 2>&1 && \
		echo "$(GREEN)â—$(NC)" || echo "$(RED)â—‹$(NC)"
	@echo -n "Backend:  "; \
	curl -s -o /dev/null -w "%{http_code}" $(API_URL) | grep -q "200\|301\|302" && \
		echo "$(GREEN)â—$(NC)" || echo "$(RED)â—‹$(NC)"

info:
	@echo "$(CYAN)E-Bike Point ERP - Frontend$(NC)"
	@echo "=========================="
	@echo "Framework:     React + Vite"
	@echo "UI Library:    Tailwind CSS"
	@echo "State Mgmt:    Zustand"
	@echo "API Client:    Axios + React Query"
	@echo "Dev Port:      $(FRONTEND_PORT)"
	@echo "Preview Port:  $(PREVIEW_PORT)"
	@echo "Backend URL:   $(BACKEND_URL)"

version:
	@echo "$(CYAN)Version Information:$(NC)"
	@echo "==================="
	@if [ -f package.json ]; then \
		APP_VERSION=$$(grep '"version"' package.json | head -1 | cut -d '"' -f4); \
		echo "App Version:   $$APP_VERSION"; \
	fi
	@echo "Node.js:       $$(node -v)"
	@echo "npm:           $$(npm -v)"
	@VITE_VERSION=$$(npm list vite 2>/dev/null | grep "vite@" | head -1 | sed 's/.*vite@//'); \
	[ -n "$$VITE_VERSION" ] && echo "Vite:          $$VITE_VERSION"
	@REACT_VERSION=$$(npm list react 2>/dev/null | grep " react@" | head -1 | sed 's/.*react@//'); \
	[ -n "$$REACT_VERSION" ] && echo "React:         $$REACT_VERSION"

# ============================================
# Aliases for convenience
# ============================================

start: dev-open
s: dev-open
d: dev
do: dev-open
b: build
p: preview-open
t: test
l: lint
f: format
i: install
c: clean
h: help

# Common typos
sever: dev
srever: dev
dve: dev
biuld: build
isntall: install
clen: clean
