.PHONY: help install clean dev stop restart check-env check-versions check-services migrate createsuperuser shell seed test logs audit celery-worker celery-beat dev-all

# Colors
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
CYAN := \033[0;36m
PURPLE := \033[0;35m
BLUE := \033[0;34m
NC := \033[0m

# Variables
PYTHON := python3
PYTHON_MIN_VERSION := 3.10
BACKEND_PORT := 8000
MONGODB_PORT := 27017
REDIS_PORT := 6379
VENV := .venv
VENV_BIN := $(VENV)/bin

help:
	@echo ""
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘       ğŸš´ E-Bike Point ERP - Backend Setup             â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(BLUE)Usage: make <targetName>$(NC)"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸš€ Quick Start$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)install$(NC)              => ğŸ“¦ Fresh installation (recommended)"
	@echo "  $(CYAN)dev$(NC)                  => ğŸ”§ Start Django server only"
	@echo "  $(CYAN)dev-all$(NC)              => ğŸš€ Start Django + Celery + Beat (tabs)"
	@echo "  $(CYAN)stop$(NC)                 => ğŸ›‘ Stop all services"
	@echo "  $(CYAN)restart$(NC)              => ğŸ”„ Clean & reinstall everything"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ’» Development$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)runserver$(NC)            => ğŸŒ Start Django server (:8000)"
	@echo "  $(CYAN)celery-worker$(NC)        => ğŸ”„ Start Celery worker"
	@echo "  $(CYAN)celery-beat$(NC)          => â° Start Celery beat scheduler"
	@echo "  $(CYAN)shell$(NC)                => ğŸš Open Django shell"
	@echo "  $(CYAN)shell-plus$(NC)           => ğŸš Open enhanced Django shell"
	@echo "  $(CYAN)dbshell$(NC)              => ğŸ—„ï¸  Open MongoDB shell"
	@echo "  $(CYAN)show-urls$(NC)            => ğŸ“‹ List all available URLs"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ—„ï¸  Database$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)migrate$(NC)              => ğŸ“Š Run Django migrations"
	@echo "  $(CYAN)makemigrations$(NC)       => ğŸ“ Create new migrations"
	@echo "  $(CYAN)createsuperuser$(NC)      => ğŸ‘¤ Create admin user (MongoDB)"
	@echo "  $(CYAN)seed$(NC)                 => ğŸŒ± Seed sample products (6 bikes)"
	@echo "  $(CYAN)seed-clear$(NC)           => ğŸ”„ Clear & reseed all products"
	@echo "  $(CYAN)backup-db$(NC)            => ğŸ’¾ Backup MongoDB database"
	@echo "  $(CYAN)restore-db$(NC)           => ğŸ“¥ Restore MongoDB from backup"
	@echo "  $(CYAN)flush-db$(NC)             => $(RED)âš ï¸  Clear entire MongoDB (DANGER!)$(NC)"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ”§ Setup & Maintenance$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)check-env$(NC)            => ğŸ” Verify .env file"
	@echo "  $(CYAN)check-services$(NC)       => ğŸ” Check MongoDB & Redis status"
	@echo "  $(CYAN)check-versions$(NC)       => ğŸ” Check Python, Node versions"
	@echo "  $(CYAN)status$(NC)               => ğŸ“Š Show complete system status"
	@echo "  $(CYAN)clean$(NC)                => ğŸ§¹ Clean cache & temp files"
	@echo "  $(CYAN)clean-all$(NC)            => ğŸ§¹ Deep clean (includes .venv)"
	@echo "  $(CYAN)collectstatic$(NC)        => ğŸ“ Collect Django static files"
	@echo "  $(CYAN)requirements$(NC)         => ğŸ“¦ Update requirements.txt"
	@echo "  $(CYAN)update-deps$(NC)          => â¬†ï¸  Update all dependencies"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ§ª Testing & Quality$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)test$(NC)                 => ğŸ§ª Run all tests"
	@echo "  $(CYAN)test-coverage$(NC)        => ğŸ“ˆ Run tests with coverage report"
	@echo "  $(CYAN)lint$(NC)                 => ğŸ” Run code linters (flake8)"
	@echo "  $(CYAN)format$(NC)               => âœ¨ Format code with black"
	@echo "  $(CYAN)audit$(NC)                => ğŸ”’ Security audit (pip check)"
	@echo ""
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(PURPLE)ğŸ“‹ Logs & Monitoring$(NC)"
	@echo "$(PURPLE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)logs$(NC)                 => ğŸ“‹ View Django application logs"
	@echo "  $(CYAN)logs-celery$(NC)          => ğŸ“‹ View Celery worker logs"
	@echo "  $(CYAN)logs-error$(NC)           => ğŸš¨ View error logs only"
	@echo ""
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Quick Start Guide:$(NC)"
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(GREEN)1.$(NC) make install              $(BLUE)# Install everything$(NC)"
	@echo "  $(GREEN)2.$(NC) make createsuperuser      $(BLUE)# Create admin account$(NC)"
	@echo "  $(GREEN)3.$(NC) make seed                 $(BLUE)# Add sample products$(NC)"
	@echo "  $(GREEN)4.$(NC) make dev-all              $(BLUE)# Start all services$(NC)"
	@echo "  $(GREEN)5.$(NC) Visit: $(CYAN)http://localhost:8000$(NC)"
	@echo ""
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(YELLOW)ğŸ“š Common Workflows:$(NC)"
	@echo "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  $(CYAN)Development:$(NC)        make dev-all"
	@echo "  $(CYAN)Testing:$(NC)            make test-coverage"
	@echo "  $(CYAN)Code Quality:$(NC)       make lint && make format"
	@echo "  $(CYAN)Database Backup:$(NC)    make backup-db"
	@echo "  $(CYAN)Fresh Start:$(NC)        make restart"
	@echo "  $(CYAN)Check Status:$(NC)       make status"
	@echo ""
	@echo "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ğŸŒ Service URLs:$(NC)"
	@echo "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  â€¢ Django:     $(CYAN)http://127.0.0.1:8000$(NC)"
	@echo "  â€¢ Admin:      $(CYAN)http://127.0.0.1:8000/admin$(NC)"
	@echo "  â€¢ API Docs:   $(CYAN)http://127.0.0.1:8000/api$(NC)"
	@echo "  â€¢ MongoDB:    $(CYAN)mongodb://localhost:27017$(NC)"
	@echo "  â€¢ Redis:      $(CYAN)redis://localhost:6379$(NC)"
	@echo ""
	@echo "$(RED)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(RED)âš ï¸  Important Notes:$(NC)"
	@echo "$(RED)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "  â€¢ Ensure MongoDB & Redis are running before 'make dev-all'"
	@echo "  â€¢ Use 'make check-services' to verify services"
	@echo "  â€¢ Update .env file with your credentials after install"
	@echo "  â€¢ Run 'make stop' to gracefully stop all services"
	@echo ""

check-versions:
	@echo "$(YELLOW)ğŸ” Checking system requirements...$(NC)"
	@command -v $(PYTHON) >/dev/null 2>&1 || { echo "$(RED)âŒ Python 3 not found!$(NC)"; exit 1; }
	@$(PYTHON) -c "import sys; exit(0 if sys.version_info >= (3, 10) else 1)" || { \
		echo "$(RED)âŒ Python 3.10+ required!$(NC)"; \
		echo "$(YELLOW)   Current: $$($(PYTHON) --version)$(NC)"; \
		exit 1; \
	}
	@command -v mongod >/dev/null 2>&1 || echo "$(YELLOW)âš ï¸  MongoDB not found in PATH (may be running as service)$(NC)"
	@command -v redis-server >/dev/null 2>&1 || echo "$(YELLOW)âš ï¸  Redis not found in PATH (may be running as service)$(NC)"
	@echo "$(GREEN)âœ“ Python: $$($(PYTHON) --version)$(NC)"

check-venv:
	@if [ -n "$$VIRTUAL_ENV" ]; then \
		echo "$(RED)âš ï¸  Virtual environment is ACTIVE$(NC)"; \
		echo "$(YELLOW)   Location: $$VIRTUAL_ENV$(NC)"; \
		echo "$(CYAN)   To deactivate, run: deactivate$(NC)"; \
		echo ""; \
	else \
		echo "$(GREEN)âœ“ No virtual environment active$(NC)"; \
	fi

check-env:
	@echo "$(YELLOW)ğŸ” Checking environment file...$(NC)"
	@if [ ! -f .env ]; then \
		echo "$(YELLOW)âš ï¸  .env file not found$(NC)"; \
		if [ -f .env.example ]; then \
			echo "$(CYAN)ğŸ“‹ Creating from .env.example...$(NC)"; \
			cp .env.example .env; \
			echo "$(GREEN)âœ“ Created .env file$(NC)"; \
			echo "$(RED)âš ï¸  IMPORTANT: Please update .env with your credentials!$(NC)"; \
			echo ""; \
			echo "$(CYAN)Required configurations:$(NC)"; \
			echo "  â€¢ SECRET_KEY"; \
			echo "  â€¢ MONGODB_NAME"; \
			echo "  â€¢ EMAIL_HOST_USER & EMAIL_HOST_PASSWORD"; \
			echo ""; \
		else \
			echo "$(RED)âŒ Please create .env file$(NC)"; \
			echo "$(CYAN)Required variables:$(NC)"; \
			echo "  SECRET_KEY=your-secret-key"; \
			echo "  DEBUG=True"; \
			echo "  MONGODB_NAME=ebikepoint_erp"; \
			echo "  MONGODB_HOST=localhost"; \
			echo "  MONGODB_PORT=27017"; \
			echo "  REDIS_HOST=127.0.0.1"; \
			echo "  REDIS_PORT=6379"; \
			exit 1; \
		fi \
	else \
		echo "$(GREEN)âœ“ .env file exists$(NC)"; \
	fi

check-services:
	@echo "$(YELLOW)ğŸ” Checking required services...$(NC)"
	@echo ""
	@echo "$(CYAN)MongoDB:$(NC)"
	@if lsof -Pi :$(MONGODB_PORT) -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "  $(GREEN)âœ“ Running on port $(MONGODB_PORT)$(NC)"; \
	else \
		echo "  $(RED)âœ— Not running on port $(MONGODB_PORT)$(NC)"; \
		echo "  $(YELLOW)  Start with: brew services start mongodb-community$(NC)"; \
		echo "  $(YELLOW)  Or run: mongod --config /usr/local/etc/mongod.conf$(NC)"; \
	fi
	@echo ""
	@echo "$(CYAN)Redis:$(NC)"
	@if lsof -Pi :$(REDIS_PORT) -sTCP:LISTEN -t >/dev/null 2>&1; then \
		echo "  $(GREEN)âœ“ Running on port $(REDIS_PORT)$(NC)"; \
	else \
		echo "  $(RED)âœ— Not running on port $(REDIS_PORT)$(NC)"; \
		echo "  $(YELLOW)  Start with: brew services start redis$(NC)"; \
		echo "  $(YELLOW)  Or run: redis-server$(NC)"; \
	fi
	@echo ""

install: check-versions
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘     ğŸ”§ Installing Backend Server          â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@if [ -n "$$VIRTUAL_ENV" ]; then \
		echo "$(YELLOW)âš ï¸  Please deactivate your venv first!$(NC)"; \
		echo "$(CYAN)   Run: deactivate$(NC)"; \
		exit 1; \
	fi
	@$(MAKE) check-services
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ Creating virtual environment (.venv)...$(NC)"
	@$(PYTHON) -m venv $(VENV)
	@echo "$(GREEN)âœ“ Virtual environment created$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ Installing dependencies...$(NC)"
	@$(VENV_BIN)/pip install --upgrade pip --quiet
	@$(VENV_BIN)/pip install -r requirements.txt --quiet
	@echo "$(GREEN)âœ“ Dependencies installed$(NC)"
	@echo ""
	@$(MAKE) check-env
	@echo ""
	@echo "$(YELLOW)ğŸ—„ï¸  Setting up database...$(NC)"
	@echo "$(CYAN)   Running Django migrations...$(NC)"
	@$(VENV_BIN)/python manage.py migrate --noinput 2>&1 || { \
		echo "$(RED)âŒ Migration failed!$(NC)"; \
		echo "$(YELLOW)ğŸ’¡ Tip: Check your MongoDB connection in .env$(NC)"; \
		exit 1; \
	}
	@echo "$(GREEN)âœ“ Migrations completed$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“ Collecting static files...$(NC)"
	@mkdir -p static staticfiles media
	@$(VENV_BIN)/python manage.py collectstatic --noinput --clear 2>&1 | grep -v "^Copying" || true
	@echo "$(GREEN)âœ“ Static files collected$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… Installation complete!$(NC)"
	@echo ""
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘           ğŸ“‹ Next Steps                      â•‘$(NC)"
	@echo "$(BLUE)â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£$(NC)"
	@echo "$(BLUE)â•‘$(NC)  1. Update .env with your credentials        $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)  2. Run 'make createsuperuser'               $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)  3. Run 'make dev-all' to start              $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)  4. Visit http://localhost:8000              $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(CYAN)Installation Summary:$(NC)"
	@echo "  â€¢ Virtual environment (.venv) âœ“"
	@echo "  â€¢ Dependencies installed âœ“"
	@echo "  â€¢ Database migrated âœ“"
	@echo "  â€¢ Static files collected âœ“"
	@echo ""

dev: check-services
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘      ğŸš€ Starting Django Server            â•‘$(NC)"
	@echo "$(PURPLE)â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£$(NC)"
	@echo "$(PURPLE)â•‘         http://127.0.0.1:$(BACKEND_PORT)             â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@$(VENV_BIN)/python manage.py runserver $(BACKEND_PORT)

dev-all:
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘   ğŸš€ Starting All Services (Tabs)         â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@$(MAKE) check-services
	@echo ""
	@echo "$(CYAN)Opening Django server in new tab...$(NC)"
	@osascript -e 'tell application "Terminal" to do script "cd \"$(PWD)\" && make runserver"' > /dev/null
	@sleep 1
	@echo "$(CYAN)Opening Celery worker in new tab...$(NC)"
	@osascript -e 'tell application "Terminal" to do script "cd \"$(PWD)\" && make celery-worker"' > /dev/null
	@sleep 1
	@echo "$(CYAN)Opening Celery beat in new tab...$(NC)"
	@osascript -e 'tell application "Terminal" to do script "cd \"$(PWD)\" && make celery-beat"' > /dev/null
	@sleep 1
	@echo ""
	@echo "$(GREEN)âœ… All services starting in new tabs!$(NC)"
	@echo ""
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘          ğŸŒ Service URLs                       â•‘$(NC)"
	@echo "$(BLUE)â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£$(NC)"
	@echo "$(BLUE)â•‘$(NC)  Django:  $(CYAN)http://127.0.0.1:8000$(NC)                $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)  Admin:   $(CYAN)http://127.0.0.1:8000/admin$(NC)          $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•‘$(NC)  API:     $(CYAN)http://127.0.0.1:8000/api$(NC)            $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ’¡ Use 'make stop' to stop all services$(NC)"
	@echo ""

runserver:
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘       ğŸ”§ Django Development Server           â•‘$(NC)"
	@echo "$(CYAN)â•‘   http://127.0.0.1:$(BACKEND_PORT)                      â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@$(VENV_BIN)/python manage.py runserver $(BACKEND_PORT)

celery-worker:
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘          ğŸ”„ Celery Worker                    â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@$(VENV_BIN)/celery -A config worker -l info

celery-beat:
	@echo "$(CYAN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(CYAN)â•‘          â° Celery Beat Scheduler            â•‘$(NC)"
	@echo "$(CYAN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@$(VENV_BIN)/celery -A config beat -l info

stop:
	@echo "$(RED)ğŸ›‘ Stopping all services...$(NC)"
	@pkill -f "manage.py runserver" 2>/dev/null || true
	@pkill -f "celery.*worker" 2>/dev/null || true
	@pkill -f "celery.*beat" 2>/dev/null || true
	@lsof -ti:$(BACKEND_PORT) | xargs kill -9 2>/dev/null || true
	@echo "$(GREEN)âœ“ All services stopped$(NC)"

clean:
	@echo "$(RED)ğŸ§¹ Cleaning temporary files...$(NC)"
	@if [ -n "$$VIRTUAL_ENV" ]; then \
		echo "$(YELLOW)âš ï¸  Warning: Virtual environment is currently active!$(NC)"; \
		echo "$(YELLOW)   After cleaning, run: deactivate$(NC)"; \
		echo ""; \
	fi
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@rm -rf .pytest_cache 2>/dev/null || true
	@rm -rf .coverage 2>/dev/null || true
	@rm -rf htmlcov 2>/dev/null || true
	@rm -rf celerybeat-schedule 2>/dev/null || true
	@rm -f celerybeat-schedule.db 2>/dev/null || true
	@echo "$(GREEN)âœ“ Cleaned temporary files$(NC)"

clean-all: clean
	@echo "$(RED)ğŸ§¹ Deep cleaning (removing .venv)...$(NC)"
	@rm -rf $(VENV) 2>/dev/null || true
	@rm -rf staticfiles 2>/dev/null || true
	@echo "$(GREEN)âœ“ Deep clean complete$(NC)"

restart:
	@echo "$(PURPLE)ğŸ”„ Restarting backend...$(NC)"
	@$(MAKE) stop
	@$(MAKE) clean
	@$(MAKE) install
	@echo ""
	@echo "$(GREEN)âœ… Ready! Run 'make dev-all' to start$(NC)"

migrate:
	@echo "$(YELLOW)ğŸ“Š Running Django migrations...$(NC)"
	@$(VENV_BIN)/python manage.py migrate
	@echo "$(GREEN)âœ“ Migrations completed$(NC)"

makemigrations:
	@echo "$(YELLOW)ğŸ“ Creating Django migrations...$(NC)"
	@$(VENV_BIN)/python manage.py makemigrations
	@echo "$(GREEN)âœ“ Migrations created$(NC)"
	@echo "$(CYAN)ğŸ’¡ Don't forget to run 'make migrate'$(NC)"

createsuperuser:
	@echo "$(CYAN)ğŸ‘¤ Creating MongoDB admin user...$(NC)"
	@echo ""
	@$(VENV_BIN)/python manage.py createsuperuser_mongo

shell:
	@echo "$(CYAN)ğŸš Opening Django shell...$(NC)"
	@$(VENV_BIN)/python manage.py shell

shell-plus:
	@echo "$(CYAN)ğŸš Opening Django shell_plus...$(NC)"
	@$(VENV_BIN)/python manage.py shell_plus 2>/dev/null || { \
		echo "$(YELLOW)âš ï¸  shell_plus not available. Installing django-extensions...$(NC)"; \
		$(VENV_BIN)/pip install django-extensions; \
		$(VENV_BIN)/python manage.py shell_plus; \
	}

dbshell:
	@echo "$(CYAN)ğŸ—„ï¸  Opening MongoDB shell...$(NC)"
	@mongosh ebikepoint_erp

seed:
	@echo "$(YELLOW)ğŸŒ± Seeding database with sample data...$(NC)"
	@echo ""
	@$(VENV_BIN)/python manage.py seed_products
	@echo ""
	@echo "$(GREEN)âœ“ Database seeded successfully$(NC)"

seed-clear:
	@echo "$(RED)âš ï¸  This will clear existing products and reseed$(NC)"
	@echo "$(YELLOW)Are you sure? (yes/no)$(NC)"
	@read -p "> " answer; \
	if [ "$$answer" = "yes" ]; then \
		$(VENV_BIN)/python manage.py seed_products --clear; \
		echo ""; \
		echo "$(GREEN)âœ“ Database cleared and reseeded$(NC)"; \
	else \
		echo "$(GREEN)Cancelled$(NC)"; \
	fi

flush-db:
	@echo "$(RED)âš ï¸  WARNING: This will delete ALL data from MongoDB!$(NC)"
	@echo "$(YELLOW)Are you sure? (yes/no)$(NC)"
	@read -p "> " answer; \
	if [ "$$answer" = "yes" ]; then \
		echo "$(RED)Flushing database...$(NC)"; \
		$(VENV_BIN)/python manage.py shell -c "from mongoengine import connection; connection.get_db().client.drop_database('ebikepoint_erp')"; \
		echo "$(GREEN)âœ“ Database flushed$(NC)"; \
		echo "$(CYAN)Run 'make migrate' to recreate tables$(NC)"; \
	else \
		echo "$(GREEN)Cancelled$(NC)"; \
	fi

status:
	@echo "$(PURPLE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(PURPLE)â•‘        ğŸ“Š Backend Status                  â•‘$(NC)"
	@echo "$(PURPLE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(CYAN)Installation:$(NC)"
	@echo "  Virtual Env: $(shell [ -d $(VENV) ] && echo '$(GREEN)âœ“ Installed (.venv)$(NC)' || echo '$(RED)âœ— Missing$(NC)')"
	@echo "  Dependencies: $(shell [ -f $(VENV_BIN)/python ] && $(VENV_BIN)/pip list --format=freeze | wc -l | xargs echo | sed 's/^/$(GREEN)/' | sed 's/$$/packages$(NC)/' || echo '$(RED)âœ— Not installed$(NC)')"
	@echo ""
	@echo "$(CYAN)Services:$(NC)"
	@echo "  MongoDB: $(shell lsof -Pi :$(MONGODB_PORT) -sTCP:LISTEN -t >/dev/null 2>&1 && echo '$(GREEN)âœ“ Running :$(MONGODB_PORT)$(NC)' || echo '$(RED)âœ— Not running$(NC)')"
	@echo "  Redis: $(shell lsof -Pi :$(REDIS_PORT) -sTCP:LISTEN -t >/dev/null 2>&1 && echo '$(GREEN)âœ“ Running :$(REDIS_PORT)$(NC)' || echo '$(RED)âœ— Not running$(NC)')"
	@echo "  Django: $(shell lsof -Pi :$(BACKEND_PORT) -sTCP:LISTEN -t >/dev/null 2>&1 && echo '$(GREEN)âœ“ Running :$(BACKEND_PORT)$(NC)' || echo '$(YELLOW)â—‹ Stopped$(NC)')"
	@echo "  Celery Worker: $(shell pgrep -f 'celery.*worker' >/dev/null 2>&1 && echo '$(GREEN)âœ“ Running$(NC)' || echo '$(YELLOW)â—‹ Stopped$(NC)')"
	@echo "  Celery Beat: $(shell pgrep -f 'celery.*beat' >/dev/null 2>&1 && echo '$(GREEN)âœ“ Running$(NC)' || echo '$(YELLOW)â—‹ Stopped$(NC)')"
	@echo ""
	@echo "$(CYAN)Environment:$(NC)"
	@echo "  .env file: $(shell [ -f .env ] && echo '$(GREEN)âœ“ Exists$(NC)' || echo '$(RED)âœ— Missing$(NC)')"
	@echo "  Python: $(shell $(PYTHON) --version 2>&1 | sed 's/Python //')"
	@echo ""
	@echo "$(CYAN)Database:$(NC)"
	@if [ -d $(VENV) ]; then \
		$(VENV_BIN)/python -c "from mongoengine import connect; connect('ebikepoint_erp'); print('  Status: \033[0;32mâœ“ Connected\033[0m')" 2>/dev/null || echo "  Status: $(RED)âœ— Cannot connect$(NC)"; \
	else \
		echo "  Status: $(YELLOW)â—‹ .venv not found$(NC)"; \
	fi
	@echo ""
	@if [ -n "$$VIRTUAL_ENV" ]; then \
		echo "$(CYAN)Virtual Environment:$(NC)"; \
		echo "  $(RED)âš ï¸  Active (run 'deactivate')$(NC)"; \
		echo ""; \
	fi

quick-check:
	@echo "$(CYAN)Quick Status Check:$(NC)"
	@echo -n "MongoDB: "; lsof -Pi :27017 -sTCP:LISTEN -t >/dev/null 2>&1 && echo "$(GREEN)âœ“$(NC)" || echo "$(RED)âœ—$(NC)"
	@echo -n "Redis: "; lsof -Pi :6379 -sTCP:LISTEN -t >/dev/null 2>&1 && echo "$(GREEN)âœ“$(NC)" || echo "$(RED)âœ—$(NC)"
	@echo -n "Django: "; lsof -Pi :8000 -sTCP:LISTEN -t >/dev/null 2>&1 && echo "$(GREEN)âœ“$(NC)" || echo "$(RED)âœ—$(NC)"

test:
	@echo "$(YELLOW)ğŸ§ª Running tests...$(NC)"
	@$(VENV_BIN)/python manage.py test

test-coverage:
	@echo "$(YELLOW)ğŸ§ª Running tests with coverage...$(NC)"
	@$(VENV_BIN)/coverage run --source='.' manage.py test
	@$(VENV_BIN)/coverage report
	@$(VENV_BIN)/coverage html
	@echo "$(GREEN)âœ“ Coverage report generated in htmlcov/$(NC)"
	@echo "$(CYAN)Open htmlcov/index.html to view$(NC)"

lint:
	@echo "$(YELLOW)ğŸ” Running linters...$(NC)"
	@$(VENV_BIN)/flake8 . --exclude=$(VENV),migrations --max-line-length=120 2>/dev/null || { \
		echo "$(YELLOW)âš ï¸  flake8 not installed. Installing...$(NC)"; \
		$(VENV_BIN)/pip install flake8 --quiet; \
		$(VENV_BIN)/flake8 . --exclude=$(VENV),migrations --max-line-length=120; \
	}

format:
	@echo "$(YELLOW)âœ¨ Formatting code with black...$(NC)"
	@$(VENV_BIN)/black . --exclude=$(VENV) 2>/dev/null || { \
		echo "$(YELLOW)âš ï¸  black not installed. Installing...$(NC)"; \
		$(VENV_BIN)/pip install black --quiet; \
		$(VENV_BIN)/black . --exclude=$(VENV); \
	}
	@echo "$(GREEN)âœ“ Code formatted$(NC)"

logs:
	@echo "$(CYAN)ğŸ“‹ Recent application logs:$(NC)"
	@echo ""
	@if [ -f logs/django.log ]; then \
		tail -n 50 logs/django.log; \
	else \
		echo "$(YELLOW)No logs found$(NC)"; \
		echo "$(CYAN)Logs will appear here after running the server$(NC)"; \
	fi

logs-celery:
	@echo "$(CYAN)ğŸ“‹ Recent Celery logs:$(NC)"
	@echo ""
	@if [ -f logs/celery.log ]; then \
		tail -n 50 logs/celery.log; \
	else \
		echo "$(YELLOW)No Celery logs found$(NC)"; \
	fi

logs-error:
	@echo "$(RED)ğŸš¨ Recent error logs:$(NC)"
	@echo ""
	@if [ -f logs/errors.log ]; then \
		tail -n 50 logs/errors.log; \
	else \
		echo "$(GREEN)No errors logged$(NC)"; \
	fi

audit:
	@echo "$(YELLOW)ğŸ” Running security audit...$(NC)"
	@echo ""
	@echo "$(CYAN)Checking Python packages:$(NC)"
	@$(VENV_BIN)/pip check 2>&1 || echo "$(YELLOW)âš ï¸  Some issues found$(NC)"
	@echo ""
	@echo "$(CYAN)Checking for known vulnerabilities:$(NC)"
	@$(VENV_BIN)/pip-audit 2>/dev/null || { \
		echo "$(YELLOW)âš ï¸  pip-audit not installed$(NC)"; \
		echo "$(CYAN)Install with: $(VENV_BIN)/pip install pip-audit$(NC)"; \
	}

requirements:
	@echo "$(YELLOW)ğŸ“¦ Updating requirements.txt...$(NC)"
	@$(VENV_BIN)/pip freeze > requirements.txt
	@echo "$(GREEN)âœ“ requirements.txt updated$(NC)"

update-deps:
	@echo "$(YELLOW)ğŸ“¦ Updating dependencies...$(NC)"
	@$(VENV_BIN)/pip install --upgrade -r requirements.txt
	@echo "$(GREEN)âœ“ Dependencies updated$(NC)"
	@echo "$(YELLOW)âš ï¸  Run 'make audit' to check for issues$(NC)"

collectstatic:
	@echo "$(YELLOW)ğŸ“ Collecting static files...$(NC)"
	@$(VENV_BIN)/python manage.py collectstatic --noinput
	@echo "$(GREEN)âœ“ Static files collected$(NC)"

show-urls:
	@echo "$(CYAN)ğŸ“‹ Available URLs:$(NC)"
	@$(VENV_BIN)/python manage.py show_urls 2>/dev/null || { \
		echo "$(YELLOW)âš ï¸  django-extensions not installed$(NC)"; \
		$(VENV_BIN)/python manage.py shell -c "from django.urls import get_resolver; [print(p.pattern) for p in get_resolver().url_patterns]"; \
	}

backup-db:
	@echo "$(YELLOW)ğŸ’¾ Creating MongoDB backup...$(NC)"
	@mkdir -p backups
	@mongodump --db=ebikepoint_erp --out=backups/backup_$$(date +%Y%m%d_%H%M%S)
	@echo "$(GREEN)âœ“ Backup created in backups/$(NC)"

restore-db:
	@echo "$(YELLOW)ğŸ“¥ Available backups:$(NC)"
	@ls -1 backups/ 2>/dev/null || echo "$(RED)No backups found$(NC)"
	@echo ""
	@echo "$(CYAN)Enter backup directory name:$(NC)"
	@read -p "> " backup; \
	if [ -d "backups/$$backup" ]; then \
		echo "$(YELLOW)Restoring from $$backup...$(NC)"; \
		mongorestore --db=ebikepoint_erp --drop backups/$$backup/ebikepoint_erp; \
		echo "$(GREEN)âœ“ Database restored$(NC)"; \
	else \
		echo "$(RED)Backup not found$(NC)"; \
	fi

version:
	@echo "$(CYAN)E-Bike Point ERP Backend$(NC)"
	@echo "Version: 1.0.0"
	@echo "Python: $$($(PYTHON) --version)"
	@echo "Django: $$($(VENV_BIN)/python -c 'import django; print(django.get_version())')"

# Aliases for common typos
server: runserver
run: runserver
start: dev
install-deps: install
update: update-deps
backup: backup-db
restore: restore-db

.DEFAULT_GOAL := help
